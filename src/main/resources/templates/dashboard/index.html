<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:include="layout :: layout">
<body>
    <th:block th:fragment="content">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </h1>
            <button class="btn btn-secondary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i>
                Refresh
            </button>
        </div>

        <!-- Filters -->
        <div class="card mb-xl">
            <div class="card-header">
                <h3 class="card-title">Filters</h3>
            </div>
            <div class="card-body">
                <form th:action="@{/dashboard}" method="get" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: var(--spacing-md); align-items: end;">
                    <div class="form-group">
                        <label class="form-label">Filter by Event</label>
                        <select name="eventId" class="form-select" onchange="this.form.submit()">
                            <option value="all" th:selected="${selectedEventId == 'all'}">All Events</option>
                            <option th:each="event : ${allEvents}" 
                                    th:value="${event.eventID}" 
                                    th:text="${event.eventName + ' (' + event.eventID + ')'}"
                                    th:selected="${selectedEventId == event.eventID}">
                                Event
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Filter by Year Level</label>
                        <select name="yearLevel" class="form-select" onchange="this.form.submit()">
                            <option value="all" th:selected="${selectedYearLevel == 'all'}">All Years</option>
                            <option th:each="yl : ${yearLevels}" 
                                    th:value="${yl}" 
                                    th:text="${yl}"
                                    th:selected="${selectedYearLevel == yl}">
                                Year
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Filter by Section</label>
                        <select name="section" class="form-select" onchange="this.form.submit()">
                            <option value="all" th:selected="${selectedSection == 'all'}">All Sections</option>
                            <option th:each="sec : ${sections}" 
                                    th:value="${sec}" 
                                    th:text="${sec}"
                                    th:selected="${selectedSection == sec}">
                                Section
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <a th:href="@{/dashboard}" class="btn btn-secondary">Clear Filters</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">This Month</div>
                <div class="stat-value primary" th:text="'₱' + ${#numbers.formatDecimal(monthlyCollections, 1, 2)}">₱0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">This Semester</div>
                <div class="stat-value primary" th:text="'₱' + ${#numbers.formatDecimal(semesterCollections, 1, 2)}">₱0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Fines Issued</div>
                <div class="stat-value" th:text="'₱' + ${#numbers.formatDecimal(totalFines, 1, 2)}">₱0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Present</div>
                <div class="stat-value success" th:text="${presentCount}">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Late</div>
                <div class="stat-value warning" th:text="${lateCount}">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Absent</div>
                <div class="stat-value error" th:text="${absentCount}">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Service Hours</div>
                <div class="stat-value success" th:text="${totalServiceHours}">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Service Credits Value</div>
                <div class="stat-value success" th:text="'₱' + ${#numbers.formatDecimal(totalServiceCredits, 1, 2)}">₱0.00</div>
            </div>
        </div>

        <!-- Course Breakdown -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Breakdown by Course</h3>
            </div>
            <div class="card-body">
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Total Fines</th>
                                <th>Total Payments</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${finesByCourse == null or finesByCourse.isEmpty()}">
                                <td colspan="3" style="text-align: center; padding: var(--spacing-xl); color: #6B7280;">No data available</td>
                            </tr>
                            <tr th:each="entry : ${finesByCourse}">
                                <td th:text="${entry.key}">Course</td>
                                <td th:text="'₱' + ${#numbers.formatDecimal(entry.value, 1, 2)}">₱0.00</td>
                                <td th:text="'₱' + ${#numbers.formatDecimal(paymentsByCourse.get(entry.key) ?: 0, 1, 2)}">₱0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </th:block>
</body>
</html>
